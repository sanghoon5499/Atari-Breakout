<!DOCTYPE html>
<html>

<!-- current bugs: 
    - Spacebar triggers sound/effects buttons
        - Solution: ?

-->



<head>
    <link href="https://fonts.googleapis.com/css2?family=Muli:wght@500&display=swap" rel="stylesheet"> 
    <title></title>
    <style>
    html, body {
        height: 100%;
        margin: 0;
    }

    body {
        background: black;
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: "Muli";
    }

    </style>
</head>
<body>
    <canvas width="750" height="585" id="game"></canvas>
        <script>
            const canvas = document.getElementById('game');
            const context = canvas.getContext('2d');
            const grid = 15; // called grid because each "pixel" is a grid unit, hence why code counts in grid units
            const paddleHeight = grid; // 15
            const maxPaddleY = 640;

            var paddleSpeed = 10;
            var ballSpeed = 5;
            var numHits = 0;
            var ballReset = false;
            var resetOnce = 0; 

            var music = false;
            var soundEffect = true;

            const paddle = {
                // start in the middle of the game in middle
                x: canvas.width/2,
                y: canvas.height-50,
                width: grid*7,
                height: paddleHeight,

                // paddle velocity
                dx: 0
            }

            const ball = {
                // start on top of paddle
                x: paddle.x+paddle.width/2,
                y: paddle.y+grid,
                width: grid,
                height: grid,

                // ball velocity (start going to the top-right corner)
                dx: ballSpeed,
                dy: -ballSpeed
            };

            /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
            // MUSIC

            function musicToggle(){
                music = !music;
                playMusic();
            }
            function soundEffectToggle(){
                soundEffect = !soundEffect;
                playHitSound();
                playBreakSound();
            }


            function playMusic() {
                var audio = document.getElementById("musicTwo");  // reference line 428
                if (music == true){
                    audio.play();
                    audio.loop = true;
                    audio.volume = 0.1;
                }
                else if (music == false){
                    //var audio = new Audio("");
                    audio.pause();
                    audio.currentTime = 0;
                }
            }


            function playHitSound() {
                var audioFXOne = document.getElementById("soundFXOne");  // reference line 429
                    if (soundEffect == true){     
                        audioFXOne.play();
                    }
                    else{
                        audioFXOne.pause();
                    }
            }
            function playBreakSound() {
                var audioFXTwo = document.getElementById("soundFXTwo");  // reference line 430
                    if (soundEffect == true){
                        audioFXTwo.play();
                    }
                    else{
                        audioFXTwo.pause();
                    }
            }

            /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
            // Create block widths
            var blockWidths = [];
            var blockWidths2 = [];
            var blockWidths3 = [];

            for (var i=0; i<4; i++){
                min = Math.ceil(100);
                max = Math.floor(160);
                var x = Math.floor(Math.random() * (max - min+1) + min);
                blockWidths.push(x);
            }
            for (var i=0; i<4; i++){
                min = Math.ceil(90);
                max = Math.floor(160);
                var x = Math.floor(Math.random() * (max - min+1) + min);
                blockWidths2.push(x);
            }
            for (var i=0; i<4; i++){
                min = Math.ceil(90);
                max = Math.floor(160);
                var x = Math.floor(Math.random() * (max - min+1) + min);
                blockWidths3.push(x);
            }

            //make sure last block always stretches to the edge of canvas
            function createBlockWidths(){
                var fourBlockLength = 15;
                for (var i=0; i<4; i++){
                    fourBlockLength+=blockWidths[i]+15;
                }
                blockWidths.push(canvas.width - fourBlockLength-15);                
            }
            function createBlockWidths2(){
                var fourBlockLength = 15;
                for (var i=0; i<4; i++){
                    fourBlockLength+=blockWidths2[i]+15;
                }
                blockWidths2.push(canvas.width - fourBlockLength-15);                
            }
            function createBlockWidths3(){
                var fourBlockLength = 15;
                for (var i=0; i<4; i++){
                    fourBlockLength+=blockWidths3[i]+15;
                }
                blockWidths3.push(canvas.width - fourBlockLength-15);                
            }

            var blocks = [];

            createBlockWidths();
            var h = grid;
            for (var i=0; i<5; i++){ 
                var block = {
                    x: h,            
                    y: grid*2,
                    width: blockWidths[i],
                    height: 70,
                    numHits: 0
                }
                h += block.width + grid;
                blocks.push(block); 
            }
            createBlockWidths2();
            h = grid;
            for (var i=0; i<5; i++){ 
                var block = {
                    x: h,            
                    y: 70+grid*3,
                    width: blockWidths2[i],
                    height: 70,
                    numHits: 0
                }
                h += block.width + grid;
                blocks.push(block); 
            }
            createBlockWidths3();
            h = grid;
            for (var i=0; i<5; i++){ 
                var block = {
                    x: h,            
                    y: 140+grid*4,
                    width: blockWidths3[i],
                    height: 70,
                    numHits: 0
                }
                h += block.width + grid;
                blocks.push(block); 
            }

            /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

            // check for collision between two objects using axis-aligned bounding box (AABB)
            // see https://developer.mozilla.org/en-US/docs/Games/Techniques/2D_collision_detection
            function collides(obj1, obj2) {
                if (obj2 == paddle) {
                    return obj1.x < obj2.x + obj2.width && 
                           obj1.x + obj1.width > obj2.x && 
                           obj1.y < obj2.y + obj2.height && 
                           obj1.y + obj1.height > obj2.y;
                }
                
                //collision with atari blocks
                else{  
                        if ( obj1.y+grid > obj2.y &&
                            obj1.y+grid < obj2.y+10 && 
                            obj1.x+grid > obj2.x && 
                            obj1.x < obj2.x+obj2.width ){  //top
                                return 1;
                        }

                        else if ( obj1.x > obj2.x+obj2.width-10 && 
                                obj1.x < obj2.x+obj2.width && 
                                obj1.y+grid > obj2.y && 
                                obj1.y < obj2.y + obj2.height ){  //right
                                    return 2; 
                        }

                        else if ( obj1.y > obj2.y+obj2.height-10 && 
                                obj1.y < obj2.y+obj2.height &&     
                                obj1.x+grid > obj2.x && 
                                obj1.x < obj2.x+obj2.width ){  //bottom
                                    return 3;
                        }

                        else if ( obj1.x+grid > obj2.x && 
                                obj1.x+grid < obj2.x+10 && 
                                obj1.y+grid > obj2.y && 
                                obj1.y < obj2.y + obj2.height ){  //left
                                    return 4;
                        }
                        else{}
                }
            }

            // game loop
            function loop() {
                requestAnimationFrame(loop);
                context.clearRect(0,0,canvas.width,canvas.height);

                // move paddles by their velocity
                paddle.x += paddle.dx;

                // prevent paddles from going through walls
                if (paddle.x < 5) {
                    paddle.x = 5;
                } 
                else if (paddle.x > maxPaddleY) {
                    paddle.x = maxPaddleY;
                }

                if (ballReset == true){
                    if (resetOnce == 0){
                        ball.dx = 0;
                        ball.dy = 0;
                    }
                    resetOnce = 1;
                }
                
                // move ball by its velocity
                if (ballReset == false){
                    ball.x += ball.dx;
                    ball.y += ball.dy;
                }
                else if (ballReset == true){
                    ball.x += ball.dx;
                    ball.y += 0;
                }
                //alert(ball.dx)

                // prevent ball from going through walls by changing its velocity
                if (ball.y < grid) {  //top
                    ball.y = grid;
                    ball.dy *= -1;
                    playBreakSound();
                }

                else if (ball.x > canvas.width - grid) {  //right
                    ball.x = canvas.width - grid;
                    ball.dx *= -1;
                    playBreakSound();
                }

                else if (ball.x < grid) {  //left
                    ball.x = grid;
                    ball.dx *= -1;
                    playBreakSound();
                }

                else if (ball.y > canvas.height - grid) {  //bottom
                    ball.x = paddle.x+paddle.width/2;
                    ball.y = canvas.height-65;
                    ballReset = true;
                }

                //prevent ball from going past paddle boundary
                if (ballReset == true && ball.x < paddle.x+grid*3){
                    ball.x = paddle.x+grid*3;
                }
                else if (ballReset == true && ball.x+grid > paddle.x+paddle.width-grid*4 ){
                    ball.x = paddle.x+paddle.width-grid*4;
                }
             
                // check to see if ball collides with paddle. if they do change x velocity
                if (collides(ball, paddle)) {
                    //ball.dy *= -1;

                    // //system to check where on the paddle ball hit to calculate angle of deflection
                    var center = ball.x + ball.width/2;
                    if (center < paddle.x+grid/2){  //below 1, but still colliding with edge
                        ball.dy = -1.35;
                        ball.dx = -8;
                    }
                    else if (center > paddle.x && center < paddle.x+grid){  //1
                        ball.dy = -2.76;
                        ball.dx = -6.51;
                    }
                    else if (center > paddle.x+grid && center < paddle.x+grid*2){  //2
                        ball.dy = -5;
                        ball.dx = -5;
                    }
                    else if (center > paddle.x+grid*2 && center < paddle.x+grid*3){  //3
                        ball.dy = -6.55;
                        ball.dx = -2.66;
                    }
                    else if (center > paddle.x+grid*2 && center < paddle.x+grid*4){  //4
                        ball.dy = -7.07;
                        ball.dx = 0;
                    }
                    else if (center > paddle.x+grid*2 && center < paddle.x+grid*5){  //5
                        ball.dy = -6.55;
                        ball.dx = 2.66;
                    }
                    else if (center > paddle.x+grid*2 && center < paddle.x+grid*6){  //6
                        ball.dy = -5;
                        ball.dx = 5;
                    }
                    else if (center > paddle.x+grid*2 && center < paddle.x+grid*7){  //7
                        ball.dy = -2.76;
                        ball.dx = 6.51;
                    }
                    else{  //greater than 7, but still colliding with edge
                        ball.dy = -1.35;
                        ball.dx = 8;
                    }


                    playHitSound();

                    // move ball above the paddle otherwise the collision will happen again
                    // in the next frame
                    ball.y = paddle.y - ball.width;
                }

                // check to see if ball collides with atari block. if they do change velocity based off of which side ball hit
                for (var i=0; i<blocks.length; i++){
                    if (collides(ball, blocks[i]) == 1 ) {
                        ball.dy *= -1;
                        ball.y = blocks[i].y - ball.width;
                        blocks[i].numHits++;
                        playHitSound();
                    } 
                    else if (collides(ball, blocks[i]) == 2 ) {
                        ball.dx *= -1;
                        ball.x = blocks[i].x+blocks[i].width + ball.width;
                        blocks[i].numHits++;
                        playHitSound();
                    } 
                    else if (collides(ball, blocks[i]) == 3 ) {
                        ball.dy *= -1;
                        ball.y = blocks[i].y+blocks[i].height + ball.width;
                        blocks[i].numHits++;
                        playHitSound();
                    } 
                    else if (collides(ball, blocks[i]) == 4 ) {
                        ball.dx *= -1;
                        ball.x = blocks[i].x - ball.width;
                        blocks[i].numHits++;
                        playHitSound();
                    } 
                }

                


                // draw paddle
                context.fillStyle = 'white';
                context.fillRect(paddle.x, paddle.y, paddle.width, paddle.height);

                // draw ball
                context.fillRect(ball.x, ball.y, ball.width, ball.height);

                // draw walls
                context.fillStyle = 'white';
                context.fillRect(0, canvas.height - 15, canvas.width, canvas.height);
                context.fillRect(0, canvas.height - 1153, canvas.width, canvas.height);

                // draw block
                
                for (var i=0; i<blocks.length; i++){    
                    var colorArray = ["#fe4a49", "#2ab7ca", "#fed766", "#005b96", "#851e3e", 
                                      "#fe8a71", "#35a79c", "#ee4035", "#f37736", "#7bc043",  
                                      "#0392cf", "#ffcc5c", "#ff6f69", "#ff5588", "#3d1e6d", 
                                      "#c68642", "#64a1f4", "#01FF70", "#39CCCC", "#7FDBFF",  
                                      "#0392cf", "#ffeead", "#ff6f69", "#ffcc5c", "#88d8b0", 
                                      "#d11141", "#00b159", "#00aedb", "#f37735", "#ffc425"];
                    if (blocks[i].numHits<2){
                        context.fillStyle = colorArray[i];
                        context.fillRect(blocks[i].x, blocks[i].y, blocks[i].width, blocks[i].height);
                    }
                    else{
                        blocks[i].x=-10;
                        blocks[i].y=-10;
                        blocks[i].width=1;
                        blocks[i].height=1;
                    }
                }

            }

            // listen to keyboard events to move the paddles
            // see https://css-tricks.com/snippets/javascript/javascript-keycodes/ for keycodes
            document.addEventListener('keydown', function(e) {

                // right arrow key
                if (e.which === 39) {
                    paddle.dx = paddleSpeed;
                    if (ballReset == true){
                        ballSpeed = paddleSpeed;
                        ball.dx = ballSpeed;
                    }
                }
                // left arrow key
                else if (e.which === 37) {
                    paddle.dx = -paddleSpeed;
                    if (ballReset == true){
                        ballSpeed = -paddleSpeed;
                        ball.dx = ballSpeed;
                    }
                }
                if (e.which === 32) {   // launch ball
                    if (ballReset == true){
                        ballSpeed = 5;
                        ball.dy=-ballSpeed;
                        ball.dx=ballSpeed;
                        ballReset = false;
                        resetOnce = 0;
                    }
                    else{}
                    
                }
                if (e.which === 27) {
                    alert("- paused -");
                }

            });

            // listen to keyboard events to stop the paddle if key is released
            document.addEventListener('keyup', function(e) {
                if (e.which === 39 || e.which === 37) {
                    paddle.dx = 0;
                    if (ballReset == true){
                        ballSpeed = 0;
                        ball.dx = ballSpeed;
                        resetOnce = 0;
                    }
                }
            });


            // start the game
            requestAnimationFrame(loop);
        </script>
        <div style="text-align: center; color: white; margin-left: 100px;">
            <h1> Atari Breakout </h1>
            <h3> by Sanghoon Choi </h3>
            <br>
            <h3> [Esc]: pause </h3>
            <h3> [Space]: shoot ball </h3>
            <br>
            <br>
            <h4> spacebar will activate buttons</h4>
            <h4> if they've been clicked on for some reason </h4>
        </div>

        

        <style>
            .button{
                background-color: black;
                color: white;
                padding: 15px 32px;
                text-align: center;
                display: inline-block;
                font-size: 16px;
                margin: 4px 2px;
                border: 2px solid white;
                font-family: "Muli";
                cursor: pointer;
            }
        </style>

        <div style="margin-left: 50px; margin-top: 20px">
            <button class="button" style="margin-left: 30px;" onclick="musicToggle()">Music</button>
            <br><br>
            <button class="button" onclick="soundEffectToggle()">Sound Effects</button>
        </div>


        <!-- music elements for line 87 -->
        <audio id="musicOne" src="audio/music.wav"></audio>
        <audio id="musicTwo" src="audio/select.wav"></audio>
        <audio id="soundFXOne" src="audio/beep.ogg"></audio>
        <audio id="soundFXTwo" src="audio/plop.ogg"></audio>
    </body>
</html>


<!-- Inspired by GitHub user straker's Basic Pong HTML Game. See https://gist.github.com/straker/81b59eecf70da93af396f963596dfdc5 -->